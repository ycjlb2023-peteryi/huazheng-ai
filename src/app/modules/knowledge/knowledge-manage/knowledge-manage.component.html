<div class="knowledge-manage">
  <app-page-header 
    title="çŸ¥è¯†åº“ç®¡ç†" 
    subtitle="ç®¡ç†ä¼ä¸šæŠ€æœ¯æ–‡æ¡£å’Œæ ‡å‡†èµ„æ–™"
  >
    <div actions>
      <button class="btn btn-primary" (click)="openUploadModal()">
        <span>ğŸ“¤</span>
        <span>ä¸Šä¼ æ–‡æ¡£</span>
      </button>
    </div>
  </app-page-header>
  
  <div class="knowledge-content">
    <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
    <div class="stats-overview">
      <div class="stat-card">
        <div class="stat-icon">ğŸ“š</div>
        <div class="stat-info">
          <h3 class="stat-value">{{ stats().total }}</h3>
          <p class="stat-label">æ€»æ–‡æ¡£æ•°</p>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">âœ…</div>
        <div class="stat-info">
          <h3 class="stat-value">{{ stats().active }}</h3>
          <p class="stat-label">å¯ç”¨ä¸­</p>
        </div>
      </div>
      @for (cat of stats().byCategory.slice(0, 3); track cat.name) {
        <div class="stat-card">
          <div class="stat-icon">ğŸ“</div>
          <div class="stat-info">
            <h3 class="stat-value">{{ cat.count }}</h3>
            <p class="stat-label">{{ cat.name }}</p>
          </div>
        </div>
      }
    </div>
    
    <!-- ç­›é€‰å’Œæœç´¢ -->
    <div class="filter-section card">
      <div class="search-box">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor" class="search-icon">
          <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
        </svg>
        <input
          type="text"
          class="search-input"
          placeholder="æœç´¢æ–‡æ¡£åç§°ã€åˆ†ç±»æˆ–äº§å“..."
          [value]="searchKeyword()"
          (input)="updateSearchKeyword($any($event.target).value)"
        />
      </div>
      
      <div class="category-filters">
        <button
          class="category-btn"
          [class.active]="selectedCategory() === 'all'"
          (click)="updateCategory('all')"
        >
          å…¨éƒ¨
        </button>
        @for (category of categories(); track category) {
          <button
            class="category-btn"
            [class.active]="selectedCategory() === category"
            (click)="updateCategory(category)"
          >
            {{ category }}
          </button>
        }
      </div>
    </div>
    
    <!-- æ–‡æ¡£åˆ—è¡¨ -->
    @if (filteredDocuments().length > 0) {
      <div class="documents-table card">
        <table class="table">
          <thead>
            <tr>
              <th>æ–‡æ¡£åç§°</th>
              <th>ç±»å‹</th>
              <th>åˆ†ç±»</th>
              <th>é€‚ç”¨äº§å“</th>
              <th>ä¼˜å…ˆçº§</th>
              <th>å¤§å°</th>
              <th>ä¸Šä¼ æ—¶é—´</th>
              <th>çŠ¶æ€</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            @for (doc of filteredDocuments(); track doc.id) {
              <tr class="table-row fade-in" [style.animation-delay]="$index * 0.03 + 's'">
                <td class="doc-name-cell">
                  <div class="doc-icon">{{ getFileIcon(doc.type) }}</div>
                  <span class="doc-name">{{ doc.name }}</span>
                </td>
                <td>
                  @switch (doc.type) {
                    @case ('pdf') { <span class="type-badge badge-pdf">PDF</span> }
                    @case ('word') { <span class="type-badge badge-word">Word</span> }
                    @case ('excel') { <span class="type-badge badge-excel">Excel</span> }
                    @case ('standard') { <span class="type-badge badge-standard">æ ‡å‡†</span> }
                  }
                </td>
                <td>{{ doc.category }}</td>
                <td>
                  <div class="products-tags">
                    @for (product of doc.applicableProducts.slice(0, 2); track product) {
                      <span class="product-tag">{{ product }}</span>
                    }
                    @if (doc.applicableProducts.length > 2) {
                      <span class="product-tag more">+{{ doc.applicableProducts.length - 2 }}</span>
                    }
                  </div>
                </td>
                <td>
                  <span class="priority-badge" [class.high]="doc.priority === 1">
                    P{{ doc.priority }}
                  </span>
                </td>
                <td class="size-cell">{{ formatFileSize(doc.size) }}</td>
                <td class="date-cell">{{ formatDate(doc.uploadedAt) }}</td>
                <td>
                  @if (doc.status === 'active') {
                    <span class="badge badge-success">å¯ç”¨</span>
                  } @else {
                    <span class="badge">å½’æ¡£</span>
                  }
                </td>
                <td class="actions-cell">
                  <button
                    class="action-btn"
                    (click)="toggleDocumentStatus(doc)"
                    [title]="doc.status === 'active' ? 'å½’æ¡£' : 'å¯ç”¨'"
                  >
                    @if (doc.status === 'active') {
                      <span>ğŸ“¦</span>
                    } @else {
                      <span>âœ…</span>
                    }
                  </button>
                  <button
                    class="action-btn danger"
                    (click)="deleteDocument(doc.id)"
                    title="åˆ é™¤"
                  >
                    ğŸ—‘ï¸
                  </button>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    } @else {
      <app-empty-state
        title="æ²¡æœ‰æ‰¾åˆ°æ–‡æ¡£"
        [description]="searchKeyword() ? 'è¯•è¯•å…¶ä»–æœç´¢å…³é”®è¯' : 'ç‚¹å‡»ä¸Šæ–¹ã€ä¸Šä¼ æ–‡æ¡£ã€‘å¼€å§‹æ·»åŠ çŸ¥è¯†åº“å†…å®¹'"
        [actionText]="!searchKeyword() ? 'ä¸Šä¼ æ–‡æ¡£' : ''"
        (action)="openUploadModal()"
      />
    }
  </div>
  
  <!-- ä¸Šä¼ å¼¹çª— -->
  @if (showUploadModal()) {
    <div class="modal-overlay" (click)="closeUploadModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">ä¸Šä¼ çŸ¥è¯†åº“æ–‡æ¡£</h2>
          <button class="close-btn" (click)="closeUploadModal()">âœ•</button>
        </div>
        
        <div class="modal-body">
          <div class="upload-area">
            <input
              type="file"
              id="fileInput"
              class="file-input"
              accept=".pdf,.doc,.docx,.xls,.xlsx"
              (change)="onFileSelect($event)"
            />
            <label for="fileInput" class="upload-label">
              @if (selectedFile()) {
                <div class="file-selected">
                  <span class="file-icon">ğŸ“„</span>
                  <span class="file-name">{{ selectedFile()!.name }}</span>
                  <span class="file-size">({{ formatFileSize(selectedFile()!.size) }})</span>
                </div>
              } @else {
                <div class="upload-placeholder">
                  <span class="upload-icon">ğŸ“¤</span>
                  <p class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½åˆ°æ­¤å¤„</p>
                  <p class="upload-hint">æ”¯æŒ PDF, Word, Excel æ ¼å¼</p>
                </div>
              }
            </label>
          </div>
          
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label">æ–‡æ¡£åç§° *</label>
              <input
                type="text"
                class="input"
                placeholder="è¾“å…¥æ–‡æ¡£åç§°"
                [value]="uploadForm().name"
                (input)="updateFormField('name', $any($event.target).value)"
              />
            </div>
            
            <div class="form-group">
              <label class="form-label">æ–‡æ¡£ç±»å‹</label>
              <select
                class="input"
                [value]="uploadForm().type"
                (change)="updateFormField('type', $any($event.target).value)"
              >
                <option value="pdf">PDFæ–‡æ¡£</option>
                <option value="word">Wordæ–‡æ¡£</option>
                <option value="excel">Excelè¡¨æ ¼</option>
                <option value="standard">å›½å®¶æ ‡å‡†</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">æ–‡æ¡£åˆ†ç±» *</label>
              <select
                class="input"
                [value]="uploadForm().category"
                (change)="updateFormField('category', $any($event.target).value)"
              >
                @for (category of categories(); track category) {
                  <option [value]="category">{{ category }}</option>
                }
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">ä¼˜å…ˆçº§</label>
              <select
                class="input"
                [value]="uploadForm().priority"
                (change)="updateFormField('priority', +$any($event.target).value)"
              >
                <option [value]="1">P1 - æœ€é«˜</option>
                <option [value]="2">P2 - é«˜</option>
                <option [value]="3">P3 - ä¸­</option>
                <option [value]="4">P4 - ä½</option>
              </select>
            </div>
            
            <div class="form-group full-width">
              <label class="form-label">é€‚ç”¨äº§å“ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
              <input
                type="text"
                class="input"
                placeholder="ä¾‹å¦‚ï¼šæ»¤æ²¹æœº, TYç³»åˆ—, æµ‹è¯•å°"
                [value]="uploadForm().applicableProducts"
                (input)="updateFormField('applicableProducts', $any($event.target).value)"
              />
            </div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button class="btn btn-secondary" (click)="closeUploadModal()">
            å–æ¶ˆ
          </button>
          <button
            class="btn btn-primary"
            (click)="submitUpload()"
            [disabled]="!selectedFile() || isUploading()"
          >
            @if (isUploading()) {
              <span class="spinner"></span>
              <span>ä¸Šä¼ ä¸­...</span>
            } @else {
              <span>ç¡®è®¤ä¸Šä¼ </span>
            }
          </button>
        </div>
      </div>
    </div>
  }
  
  @if (isUploading()) {
    <app-loading-spinner
      [fullscreen]="true"
      text="æ­£åœ¨ä¸Šä¼ æ–‡æ¡£..."
      [size]="60"
    />
  }
</div>

